<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>福州市古厝文化信息检索与展示系统</title>
    <link rel="icon" type="image/x-icon" href="/images/title.ico" />
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    <link href="/css/second.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="/css/sweetalert.css">
    <script type="text/javascript" src="/js/sweetalert-dev.js"></script>
    <script type="text/javascript"
        src="http://api.map.baidu.com/api?v=2.0&ak=2GVVoVth63ABPvY68rX4dek93chHmGjT"></script>
    <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript"
        src="//api.map.baidu.com/library/TextIconOverlay/1.2/src/TextIconOverlay_min.js"></script>
    <script type="text/javascript" src="/js/MarkerClusterer.js"></script>
    <script type="text/javascript" src="/js/lushu.js"></script>
</head>

<body>
    <div id="msg"
        style="z-index: 1901; display:none;position: absolute;left:20vw;top:20vh;background: white;border-radius: 5px;padding: 5px 10px 5px 10px;border: 1px solid gray;">
    </div>
    <iframe src="navbar.html"style="display:block;width: 100%;height: 12.5%;" frameborder="0"></iframe>
    <iframe src="navbar2.html" style="display:block;float:left;width: 11.5%;height: 87.5%;" frameborder="0"></iframe>
    <div class="container" id="allmap" style="width: 71.35%;float: left;"></div>
    <div id="tab" style="width: 17%;height:87.5%;float:left;"></div>
</body>
<script type="text/javascript" src="/js/map.js"></script>
<script>
    document.getElementById("t1").style.display = "none"
    document.getElementById("t2").style.display = "none"
    var htmlstr = "";
    htmlstr += `<table id="table" style="margin-bottom: 5px;" class="table table-hover" border="1px solid gray">
    <thead>
        <tr>
            <th style="text-align: center;">站点</th>
            <th style="text-align: center;">操作</th>
        </tr>
    </thead>
    <tbody>
        <tr id="clo">
           <td style="padding: 1.95%;vertical-align: middle;text-align:center;"><input class='form-control' id = "txt1" placeholder = "请输入站点" /></td>
           <td><div class="btn-group">
	<button type="button" class="btn btn-primary dropdown-toggle btn-sm" 
			data-toggle="dropdown">
		操作 <span class="caret"></span>
	</button>
	<ul class="dropdown-menu" role="menu" style="min-width:10%">
		<li><a onclick = sk2(this)>定位</a></li>
        <li class="divider"></li>
		<li><a onclick="del()">删除</a></li>
	</ul>
</div></td>
        </tr>
    </tbody>
    </table>`;
    htmlstr += `<a style="margin-left: 20%;text-align: center;" class="btn btn-info btn-sm" onclick="fun()">添加</a>
    <a style="text-align: center;" class="btn btn-success btn-sm" onclick="query()">查询</a>`;
    document.getElementById("tab").innerHTML = htmlstr
</script>
<script>
    arrayLookup = function (data, key, value, targetKey) {
        var targetValue = "";
        for (var i = 0; i < data.length; i++) {
            if (data[i][key] == value) {
                targetValue = data[i][targetKey];
                break;
            }
        }
        return targetValue;
    }
</script>
<script type="text/javascript">
    //添加坐标自定义显示控件
    map.addEventListener("mousemove", function (e) {
        var jing_du_value = e.point.lng;
        var wei_du_value = e.point.lat;
        var cengji_value = e.target.getZoom();
        //alert(e.point.lng + "," + e.point.lat);
        var a = document.getElementById("aa");
        a.innerHTML = "经度：" + jing_du_value + "丨" + "纬度：" + wei_du_value + "丨" + "放大层级：" + cengji_value;
    });
    map.addEventListener("moving", function (e) {
        const { lng, lat } = map.getCenter();
        var C_jing_du_value = lng;
        var C_wei_du_value = lat;
        //alert(e.point.lng + "," + e.point.lat);
        var c = document.getElementById("cc");
        c.innerHTML = "地图中心经度：" + C_jing_du_value + "丨" + "地图中心纬度：" + C_wei_du_value;
    });

    function a() {
        this.defaultAnchor = BMAP_ANCHOR_BOTTOM_RIGHT;
        this.defaultOffset = new BMap.Size(610, 16);
    }
    a.prototype = new BMap.Control();
    a.prototype.initialize = function (map) {
        var div = document.createElement("div");
        div.id = "aa"
        div.innerText = "经度：119.590546丨纬度：25.880033丨放大层级：11"
        div.style.width = "350px";
        map.getContainer().appendChild(div);
        return div;
    };
    var myZoomCtrl = new a();
    map.addControl(myZoomCtrl);
    //开源API工具控件
    function c() {
        this.defaultAnchor = BMAP_ANCHOR_BOTTOM_RIGHT;
        this.defaultOffset = new BMap.Size(610, 0);
    }
    c.prototype = new BMap.Control();
    c.prototype.initialize = function (map) {
        var div = document.createElement("div");
        div.id = "cc"
        div.style.width = "350px";
        div.innerText = "地图中心经度：119.41347丨地图中心纬度：26.14965"
        map.getContainer().appendChild(div);
        return div;
    };
    var myZoomCtrl = new c();
    map.addControl(myZoomCtrl);
    //开源API工具控件


    var xhr = new XMLHttpRequest();
    xhr.open("GET", "/php/users.php", true);
    xhr.onload = function () {
        var users = JSON.parse(this.responseText); //拿数据

        fun = function () {
            var $td = $("#clo").clone();       //增加一行,克隆第一个对象
            $("#table").append($td);
            $("table tr:last").find(":input").val('');   //将尾行元素克隆来的保存的值清空
            for (i = 0; i < $(".form-control").length; i++) {
                $(".form-control")[i].id = "txt" + (i + 1)
                document.getElementById("txt" + (i + 1)).addEventListener("input", handle("txt" + (i + 1)));
            }
            if (document.getElementById("table").clientHeight > document.getElementById("allmap").clientHeight) {
                document.getElementById("tab").style.height = document.getElementById("allmap").clientHeight + "px"
                document.getElementById("tab").style.overflow = "scroll"
            }
        }
        del = function () {
            $("table tr:not(:first):not(:first):last").remove();//移除最后一行,并且保留前两行
        }
        var gucuo = []
        query = function () {
            markerClusterer.clearMarkers()
            map.clearOverlays()

            for (i = 0; i < $(".form-control").length; i++) {
                gucuo[i] = new Array()
                gucuo[i].name = $(".form-control")[i].value
            }
            var points = []
            for (i = 0; i < gucuo.length; i++) {
                points[i] = new BMap.Point(arrayLookup(users, 'name', gucuo[i].name, 'xposition'), arrayLookup(users, 'name', gucuo[i].name, 'yposition'))
                var marker = new BMap.Marker(points[i]);
                map.addOverlay(marker);
                marker.enableMassClear();
                label = new BMap.Label(gucuo[i].name, {
                    offset: new BMap.Size(-20, 25),
                    enableMassClear: true
                }); //创建marker点的标记,这里注意下,因为百度地图可以对label样式做编辑,
                label.setStyle({
                    background: "rgb(226, 240, 243)",
                }); //对label 样式隐藏 
                marker.setLabel(label); //把label设置到maker上 	
            }
            var landmarkPois = [];
            for (i = 0; i < gucuo.length; i++) {
                landmarkPois[i] = new Array()
                landmarkPois[i].lng = arrayLookup(users, 'name', gucuo[i].name, 'xposition')
                landmarkPois[i].lat = arrayLookup(users, 'name', gucuo[i].name, 'yposition')
                img = arrayLookup(users, 'name', gucuo[i].name, 'img1')
                landmarkPois[i].html = '<img src=' + img + ' style="width: 200px;height: 130px;" /></br><span style="font-size:15px;">' + gucuo[i].name + '到了！</span>'
                landmarkPois[i].pauseTime = 1
            }
            //用站点画出路线，参数：站点、线路颜色、线路宽度、透明度
            var sy = new BMap.Symbol(BMap_Symbol_SHAPE_BACKWARD_OPEN_ARROW, {
                scale: 0.6,//图标缩放大小
                strokeColor: '#fff',//设置矢量图标的线填充颜色
                strokeWeight: '2',//设置线宽
            });
            var icons = new BMap.IconSequence(sy, '10', '30');
            var polyline = new BMap.Polyline(points, {
                strokeColor: "#5298ff",
                icons: [icons],
                enableClicking: false,//是否响应点击事件，默认为true
                strokeWeight: 6,
                strokeOpacity: 0.8
            });
            polyline.enableMassClear()
            map.addOverlay(polyline); //添加轨迹到地图

            var lushu = new BMapLib.LuShu(map, points, {
                //landmarkPois:此参数是路书移动的时候碰到这个点会触发pauseTime停留中设置的时间，单位为秒，经纬度误差超过十米不会停止
                landmarkPois: landmarkPois,
                defaultContent: '动车继续前行，况且况且...',
                speed: 30000, //速度，单位米每秒
                icon: new BMap.Icon('/images/hightTrain.png', new BMap.Size(48, 48), {
                    anchor: new BMap.Size(24, 34)
                }), //声明高铁标注
                autoView: false,
                enableRotation: false
            });

            document.getElementById("tz").onclick = function () {
                alert("将在下一站点后调整车速为 " + document.getElementById("sp1").value + " 米/秒，")
                lushu._opts.speed = document.getElementById("sp1").value;
            };
            document.getElementById("start").onclick = function () {
                lushu.start();
            };
            document.getElementById("pause").onclick = function () {
                lushu.pause();
            };
            document.getElementById("stop").onclick = function () {
                lushu.stop();
            };
            document.getElementById("hide").onclick = function () {
                lushu.hideInfoWindow();
            };
        }
        sk2 = function (obj) {
            var name = $(obj).parent().parent().parent().parent().parent().find("td").eq(0).find("input").val();
            var xposition = arrayLookup(users, 'name', name, 'xposition')
            var yposition = arrayLookup(users, 'name', name, 'yposition')
            var img1 = arrayLookup(users, 'name', name, 'img1')
            var address = arrayLookup(users, 'name', name, 'address')
            var type = arrayLookup(users, 'name', name, 'type')
            var grade = arrayLookup(users, 'name', name, 'grade')
            var located = arrayLookup(users, 'name', name, 'located')
            var buildtime = arrayLookup(users, 'name', name, 'buildtime')
            var xiangxi = arrayLookup(users, 'name', name, 'xiangxi')

            var content = '<div class="div2"><div id="' + name + '" class="carousel slide" style="width: 200px;height: 130px;">' +
                '<ol class="carousel-indicators" style="height: 0px">' +
                '<li data-target="#' + name + '" data-slide-to="0" class="active"></li>' +
                '<li data-target="#' + name + '" data-slide-to="1"></li>' +
                '<li data-target="#' + name + '" data-slide-to="2"></li></ol><div class="carousel-inner" id="pic"><div class="item active">' +
                '<img src=' + img1 + ' alt="First slide" style="width: 200px;height: 130px;"><div class="carousel-caption" style="width: 120px;height: 0px;">第一张</div></div><div class="item">' +
                '<img src=' + img1 + ' alt="Second slide" style="width: 200px;height: 130px;"><div class="carousel-caption" style="width: 120px;height: 0px;">第二张</div></div><div class="item">' +
                '<img src=' + img1 + ' alt="Third slide" style="width: 200px;height: 130px;"><div class="carousel-caption" style="width: 120px;height: 0px;">第三张</div></div></div>' +
                '<a class="left carousel-control" style="background:transparent;" href="#' + name + '" role="button" data-slide="prev">' +
                '<span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>' +
                '<span class="sr-only">Previous</span></a>' +
                '<a class="right carousel-control" style="background:transparent;" href="#' + name + '" role="button" data-slide="next">' +
                '<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>' +
                '<span class="sr-only">Next</span>' +
                '</a><div style="background-color: aliceblue;margin-top: 15px;border-radius: 10px;">' +
                '<div class="p1"><a >' + name + '</a></div><div class="p2">' +
                '<span class="p">地址：' + address + '</span><br>' +
                '<span class="p">类别：' + type + '</span><br>' +
                '<span class="p">保护等级：' + grade + '</span><br>' +
                '<span class="p">所在地：' + located + '</span><br>' +
                '<span class="p">建造年代：' + buildtime + '</span><br>' +
                '<a id="button2" type="button" class="btn btn-primary" onclick= swal("' + name + '","' + xiangxi + '")>详情</a>'
            '</div></div></div></div>'
            var opts = {
                enableAutoPan: true, // 是否开启信息窗口打开时地图自动移动，本应开启，但API v3.0 此功能有问题,后面在打开信息窗口内重写这种效果
            };
            var point = new BMap.Point(xposition, yposition);
            var infoWindow = new BMap.InfoWindow(content, opts); // 创建信息窗口对象
            map.openInfoWindow(infoWindow, point); //开启信息窗口
        }

        sk = function (name, txt) {
            document.getElementById(txt).value = name;
            $("#msg").hide()
        }
        handle = function (args) {
            return function (e) {
                var word = document.getElementById(args).value;
                document.getElementById("msg").style.width = "" + (document.getElementById("" + args + "").clientWidth + 2.5) + "px";
                document.getElementById("msg").style.left = "" + $("#" + args + "").offset().left + "px";
                document.getElementById("msg").style.top = "" + ($("#" + args + "").offset().top + document.getElementById("" + args + "").clientHeight + 2) + "px";
                var value = "";
                for (var i in users) {
                    if (word != "" && users[i].name.match(word + ".*") != null) {
                        $("#msg").show()
                        value += `<a href="javascript:void(0)" onclick=sk("${users[i].name}","${args}")>${users[i].name}</a><br/>`
                    }
                    if (word == "") {
                        $("#msg").hide()
                    }
                }
                document.getElementById('msg').innerHTML = value;
            }
        }

        //firefox下检测状态改变只能用oninput,且需要用addEventListener来注册事件。   
        if (/msie/i.test(navigator.userAgent)) //ie浏览器   
        {
            document.getElementById("txt1").onpropertychange = handle("txt1")
        } else { //非ie浏览器，比如Firefox 
            document.getElementById("txt1").addEventListener("input", handle("txt1"));
        }
        //多点标注窗体

    }
    xhr.send();

    function inputgroup() {
        this.defaultAnchor = BMAP_ANCHOR_TOP_LEFT;
        this.defaultOffset = new BMap.Size(15, 13);
    }
    inputgroup.prototype = new BMap.Control();
    inputgroup.prototype.initialize = function (map) {
        var div = document.createElement("div");
        div.id = "inputgroup"
        div.className = "input-group"
        div.innerHTML = `<span class="input-group-btn">
              <a class="btn btn-default sec">当前车速</a>
            </span><input id="sp1" value="30000" />
            <span class="input-group-btn">
              <a id="tz" class="btn btn-default sec" onclick>调整</a>
            </span>`
        div.style.width = "239.42px";
        map.getContainer().appendChild(div);
        return div;
    };
    var myCtrl = new inputgroup();
    map.addControl(myCtrl);

    function b12() {
        this.defaultAnchor = BMAP_ANCHOR_TOP_LEFT;
        this.defaultOffset = new BMap.Size(157, 14);
    }
    b12.prototype = new BMap.Control();
    b12.prototype.initialize = function (map) {
        var e1 = document.createElement("h6");
        e1.innerHTML = "米/秒";
        e1.style.color = "black";
        map.getContainer().appendChild(e1);
        //返回DOM
        return e1;
    };
    var myZoomCtrl = new b12();
    map.addControl(myZoomCtrl);



    function staticControl() {
        this.defaultAnchor = BMAP_ANCHOR_TOP_LEFT;
        this.defaultOffset = new BMap.Size(15, 50);
    }
    //继承Control的API
    staticControl.prototype = new BMap.Control();
    //初始化控件
    staticControl.prototype.initialize = function (map) {
        var div = document.createElement("div");
        var e1 = document.createElement("input");
        e1.id = "start"
        e1.type = "button";
        e1.className = "btn btn-primary btn-sm";
        e1.value = "开始▶";
        e1.onclick = function () {
            lushu.start();

        };
        div.appendChild(e1);
        var e2 = document.createElement("input");
        e2.type = "button";
        e2.id = "pause"
        e2.className = "btn btn-primary btn-sm";
        e2.value = "暂停‖";
        e2.onclick = function () {
            lushu.pause();

        };
        div.appendChild(e2);
        var e3 = document.createElement("input");
        e3.type = "button";
        e3.id = "stop"
        e3.className = "btn btn-primary btn-sm";
        e3.value = "重放■";
        e3.onclick = function () {
            lushu.stop();
        };
        div.appendChild(e3);
        var e4 = document.createElement("input");
        e4.id = "hide"
        e4.type = "button";
        e4.style.Size = "75px"
        e4.className = "btn btn-primary btn-sm";
        e4.value = "隐藏信息窗";
        e4.onclick = function () {
            lushu.hideInfoWindow();
        };
        div.appendChild(e4);
        //添加DOM元素到地图中
        map.getContainer().appendChild(div);
        //返回DOM
        return div;
    };
    var staticsCtrl = new staticControl();
    //添加到地图当中
    map.addControl(staticsCtrl);
</script>

</html>