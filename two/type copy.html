<!DOCTYPE html>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<html>

<head>
	<meta name="viewport"
		content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
	<link rel="stylesheet" type="text/css" href="/leaflet/leaflet.css" />
	<link rel="stylesheet" type="text/css" href="/leaflet/leaflet.label.css" />
	<script src="/leaflet/leaflet.js"></script>
	<script src="/js/leaflet.ChineseTmsProviders.js"></script>
	<script src="/js/leaflet.ajax.js"></script>
	<link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
	<link href="/css/second.css" rel="stylesheet" type="text/css">
	<link rel="stylesheet" type="text/css" href="/css/sweetalert.css">
	<script type="text/javascript" src="/js/sweetalert-dev.js"></script>
	<script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
	<script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="https://cdn.bootcss.com/echarts/4.4.0-rc.1/echarts-en.common.js"></script>
	<script type="text/javascript" src="/js/sweetalert-dev.js"></script>
	<script type="text/javascript" src="/js/data.js"></script>
	<style>
		html,
		body,
		#map {
			height: 100%;
		}

		body {
			padding: 0;
			margin: 0;
		}

		.label {
			font-weight: 700;
			text-transform: uppercase;
			text-align: center;
			margin-top: -1em;
			visibility: hidden;
		}

		#button {
			position: absolute;
			right: 5vw;
			top: 2vh;
		}

		.sweetAlert {
			width: 80em;
			margin: 0 auto;
			left: 0;
			right: 0;
		}
	</style>
	<title>leaflet加载天地图</title>
</head>

<body>
	<div id="map"></div>
	<div id="button">
		<button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
			统计<span class="caret"></span>
		</button>
		<ul class="dropdown-menu" role="menu" style="min-width:10%">
			<li><a onclick="TJ()">统计个数</a></li>
			<li class="divider"></li>
			<li><a onclick="CX(this)">统计面积</a></li>
		</ul>
	</div>

	<script type="text/javascript">
		//地图初始化，设置中心位置及显示级别
		function delRepeat(arr) {
			// 定义一个新数组
			var newArr = [];
			// 遍历传进来的数组
			for (var i = 0; i < arr.length; i++) {
				// 如果newArr里没有arr[i]
				if (newArr.indexOf(arr[i]) == -1) {
					// 把arr[i]传进新数组
					newArr.push(arr[i]);
				}
			}
			// 返回新数组
			return newArr;
		}
		function removeEmptyEle(arr) {
			for (var i = 0; i < arr.length; i++) {
				if (arr[i] == null) {
					arr.splice(i, 1);
					i = i - 1; // i - 1 ,因为空元素在数组下标 2 位置，删除空之后，后面的元素要向前补位，
					// 这样才能真正去掉空元素,觉得这句可以删掉的连续为空试试，然后思考其中逻辑
				}
			}
			return arr;
		};


		var data = []
		var t = []
		var type = []
		for (i = 0; i < datas.features.length; i++) {
			data[i] = new Array
			data[i].name = datas.features[i].properties.Name
			data[i].type = datas.features[i].properties.Type
			t[i] = datas.features[i].properties.Type
			data[i].area = datas.features[i].properties.Shape_Area
		}
		type = delRepeat(t)
		console.log(type)


		var type_count = []
		for (i = 0; i < type.length; i++) {
			type_count[i] = 0
			for (y = 0; y < t.length; y++) {
				if (t[y] == type[i])
					type_count[i]++;
			}
		}
		let type_result = [];
		for (let index in type) {
			type_result.push({ value: type_count[index], name: type[index] });
		}
		console.log(type_result)
		var type_color = ["RGB(97,153,0)","RGB(97,153,0)"]
		/* for (i = 0; i < type.length; i++) {
			type_color[i] = "#" + ("00000" + ((Math.random() * 16777215 + 0.5) >> 0).toString(16)).slice(-6);
		} */


		var map = L.map('map', {
			center: [26.03276, 119.20553],
			zoom: 16
		}
		);
		//设置天地图的电子地图数据的来源。
		var normalm = L.tileLayer.chinaProvider('TianDiTu.Normal.Map', {
			maxZoom: 18,
			minZoom: 5
		});

		var normala = L.tileLayer.chinaProvider('TianDiTu.Normal.Annotion', {
			maxZoom: 18,
			minZoom: 5
		});

		var imgm = L.tileLayer.chinaProvider('TianDiTu.Satellite.Map', {
			maxZoom: 18,
			minZoom: 5
		});

		var imga = L.tileLayer.chinaProvider('TianDiTu.Satellite.Annotion', {
			maxZoom: 18,
			minZoom: 5
		});

		//创建天地图电子地图的图层组，将电子地图与注记图层组合，形成图层组
		var normal = L.layerGroup([normalm, normala]);
		//将天地图电子地图加载到map组件上。
		map.addLayer(normal);


		//创建天地图电子地图的图层组，将电子地图与注记图层组合，形成电子地图图层组
		var normal = L.layerGroup([normalm, normala]);
		//创建天地图影像地图的图层组，将影像地图与注记图层组合，形成影像地图图层组
		var image = L.layerGroup([imgm, imga]);

		var baseLayers = {
			"地图": normal,
			"影像": image
		}
		//定义办公楼标记 
		var Name
		var sd = new L.GeoJSON.AJAX('/data/data2.json', {
			style: styleFunction,
			//针对每个要素，在加载时绑定一个弹出框
			onEachFeature: function (feature, layer) {
				Name = feature.properties.Name

				/* layer.bindPopup('<div>' + feature.properties.name + '<div><br>' + '<img src=' + feature.properties.img + ' style="width: 200px;height: 130px;">' + feature.properties.type + '<div>'); */
				layer.bindPopup('<div style="background-color: aliceblue;margin-top: 15px;border-radius: 10px;width: 200px;">' +
					'<div class="p1"><a >' + feature.properties.Name + '</a></div><div class="p2" style="padding: 5px 10px 5px 10px">' +
					'<span class="p">类型：' + feature.properties.Type + '</span><br>' +
					'<span class="p">周长：' + feature.properties.Shape_Leng + '</span><br>' +
					'<span class="p">面积：' + feature.properties.Shape_Area + '</span><br>' +
					'<span class="p">居住人数：' + feature.properties.peoplelive + '</span><br>' +
					'<span class="p">高度：' + feature.properties.Height + '</span></div></div>');

				if (feature.properties.f != "") {
					var label = L.marker(layer.getBounds().getCenter(), {
						icon: L.divIcon({
							className: 'label',
							html: feature.properties.Name,
							iconSize: [5, 5]
						})
					}).addTo(map);
				}
			}

		});

		sd.addTo(map);

		//将两个图层组，组成一个对象集合。
		var myLayers = {
			"师大设施": sd,
		};

		L.control.layers(baseLayers, myLayers).addTo(map);
		map.on('zoomend', function (e) {
			if (map.getZoom() >= 17) {
				var a = document.getElementsByClassName("leaflet-marker-icon label leaflet-zoom-animated leaflet-clickable")
				for (i = 0; i < a.length; i++) {
					a[i].style.visibility = "visible";
					a[i].style.fontSize = (map.getZoom() - 16) * 7.5 + "px";
				}
			}
			else {
				var a = document.getElementsByClassName("leaflet-marker-icon label leaflet-zoom-animated leaflet-clickable")
				for (i = 0; i < a.length; i++) {
					a[i].style.visibility = "hidden";
				}
			}
		})

		/* 	map.on('click', function (e) {
				L.popup().setLatLng(e.latlng).setContent(e.latlng.toString()).openOn(map)
			}) */
		function styleFunction(feature) {
			switch (feature.properties.Type) {
				case '主干道':
					return {
						color: "RGB(97,153,0)",
						opacity: 1,
					};
					break;
				case '体育设施':
					return {
						color: "RGB(146,186,0)",
						opacity: 1,
					};
					break;
				case '公共服务设施':
					return {
						color: "RGB(255,255,115)",
						opacity: 1,
					};
					break;
				case '公路':
					return {
						color: "RGB(197,219,0)",
						opacity: 1,
					};
					break;
				case '办公楼':
					return {
						color: "RGB(255,217,0)",
						opacity: 1,
					};
					break;
				case '宿舍楼':
					return {
						color: "RGB(255,174,0)",
						opacity: 1,
					};
					break;
				case '教学设施':
					return {
						color: "RGB(255,132,0)",
						opacity: 1,
					};
					break;
				case '未建设用地':
					return {
						color: "RGB(115,115,0)",
						opacity: 1,
					};
					break;
				case '次级道路及广场':
					return {
						color: "RGB(255,255,0)",
						opacity: 1,
					};
					break;
				case '水体':
					return {
						color: "RGB115,178,255)",
						opacity: 1,
					};
					break;
				case '草地':
					return {
						color: "RGB(76,230,0)",
						opacity: 1,
					};
					break;
			}
		}
		TJ = function () {

			swal({
				title: "福州市古厝信息统计分析",
				text: `<div class="dropdown"><a type="button" class="btn dropdown-toggle" id="dropdownMenu1" data-toggle="dropdown">
                        统计类型<span class="caret"></span></a>
	<ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1" >
		<li role="presentation" >
			<a role="menuitem" tabindex="-1" onclick=cd_located()>辖区统计</a>
		</li>
        <li role="presentation" class="divider"></li>
		<li role="presentation">
			<a role="menuitem" tabindex="-1" onclick=cd_type()>类别统计</a>
		</li>
        <li role="presentation" class="divider"></li>
		<li role="presentation">
			<a role="menuitem" tabindex="-1" onclick=cd_grade()>保护等级统计</a>
		</li>
        <li role="presentation" class="divider"></li>
        <li role="presentation">
			<a role="menuitem" tabindex="-1" onclick=cd_buildtime()>建造年代统计</a>
		</li>
	</ul>
</div><div id="count"><div id='count_bar' style='height:20em;width:33em;float:left'></div><div id='count_pie' style='height:20em;width:33em;float:left'></div></div>
      <div id="type" style="display:none;"><div id='type_bar' style='height:20em;width:33em;float:left'></div><div id='type_pie' style='height:20em;width:33em;float:left'></div></div>
      <div id="grade" style="display:none;"><div id='grade_bar' style='height:20em;width:33em;float:left'></div><div id='grade_pie' style='height:20em;width:33em;float:left'></div></div>
      <div id="buildtime" style="display:none;"><div id='buildtime_bar' style='height:20em;width:33em;float:left'></div><div id='buildtime_pie' style='height:20em;width:33em;float:left;'></div></div>`,
				html: true,
				customClass: "sweetAlert"
			});

			cd_count = function () {
				document.getElementById("count").style.display = ""
				document.getElementById("area").style.display = "none"
			}
			cd_area = function () {
				document.getElementById("count").style.display = "none"
				document.getElementById("area").style.display = ""
			}


			var count_bar = echarts.init(document.getElementById('count_bar'));
			var option = {
				toolbox: {
					show: true,
					x: '10%',
					feature: {
						dataView: { //数据视图
							show: true
						},
						saveAsImage: {//保存图片
							show: true
						},
					}
				},
				tooltip: {
					show: true,
				},
				xAxis: [
					{
						type: 'category',
						data: type,
						axisLabel: {
							interval: 0,
							formatter: function (value) {
								return value.split("").join("\n");
							}
						}
					}
				],
				grid: {
					top: "20px",
					left: "50px",
					right: "15px",
					bottom: "55px"
				},
				yAxis: [ //纵坐标
					{
						type: 'value',
						axisLabel: {
							show: true,
							formatter: '{value}个',//给Y轴数值添加百分号
						},
						axisLine: {
							lineStyle: {
								color: "black",//纵坐标线条颜色
							}
						}
					}
				],
				series: [
					{
						"name": "个数",
						"type": "bar",
						"data": type_result,
						"itemStyle": {
							normal: {
								label: {
									show: true,
									position: 'top', //柱子上方显示数值
									formatter: '{c}' //数值加上'个'
								},
								color: function (params) {
									// build a color map as your need.
									var colorList = type_color;
									return colorList[params.dataIndex]
								},
							}

						}
					}
				]
			};
			count_bar.setOption(option);

			var count_pie = echarts.init(document.getElementById('count_pie'));
			option = {
				toolbox: {
					show: true,
					x: '10%',
					feature: {
						restore: { //重置
							show: true
						},
						saveAsImage: {//保存图片
							show: true
						},
					}
				},
				tooltip: {
					trigger: 'item',
					formatter: "{a}<br/>{b}: {c}个 ({d}%)",
				},
				legend: {
					type: 'scroll',
					show: true,
					orient: 'vertical',
					x: 'right',
					data: type
				},//图例属性，以饼状图为例，用来说明饼状图每个扇区，data与下边series中data相匹配
				graphic: {
					type: 'text',
					left: 'center',
					top: 'center',
					style: {
						text: '类别统计\n' + type.length + '类\n' + t.length + '单元', //使用“+”可以使每行文字居中
						textAlign: 'center',
						font: 'italic bolder 16px cursive',
						fill: '#000',
						width: 30,
						height: 30
					}
				},//此例饼状图为圆环中心文字显示属性，这是一个原生图形元素组件，功能很多
				series: [
					{
						name: '类别统计',//tooltip提示框中显示内容
						type: 'pie',//图形类型，如饼状图，柱状图等
						radius: ['40%', 95 - 0.8 * type.length + '%'],//饼图的半径，数组的第一项是内半径，第二项是外半径。支持百分比，本例设置成环形图。具体可以看文档或改变其值试一试
						/* roseType:'area',//是否显示成南丁格尔图，默认false */
						itemStyle: {
							normal: {
								label: {
									show: true,
									textStyle: { color: '#3c4858', fontSize: "12" },
									formatter: function (val) {   //让series 中的文字进行换行
										return val.name.split("-").join("\n");
									}
								},//饼图图形上的文本标签，可用于说明图形的一些数据信息，比如值，名称等。可以与itemStyle属性同级，具体看文档
								labelLine: {
									show: true,
									lineStyle: { color: '#3c4858' }
								}//线条颜色
							},//基本样式
							emphasis: {
								shadowBlur: 10,
								shadowOffsetX: 0,
								shadowColor: 'rgba(0, 0, 0, 0.5)',//鼠标放在区域边框颜色
								textColor: '#000'
							}//鼠标放在各个区域的样式
						},
						data: type_result,//数据，数据中其他属性，查阅文档
						color: type_color,//各个区域颜色
					},//数组中一个{}元素，一个图，以此可以做出环形图
				],//系列列表
			};
			count_pie.setOption(option);
		}

	</script>
</body>

</html>