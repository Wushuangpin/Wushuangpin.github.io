<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>FindTask属性查询</title>
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="http://localhost:82/arcgis_js_api/library/3.20/3.20/esri/css/esri.css" />
    <script src="http://localhost:82/arcgis_js_api/library/3.20/3.20/init.js"></script>
</head>

<body>
    <div id="mapDiv" style="width: 83%;float: left; height: 100vh;border: 1px solid #000;"></div>
    <div style="width: 16.5%;float: left; height: 100vh;margin-left: 5px;">
        <div style="margin: 10px;">
            <input class='form-control' id="txtSearchText" value="敖东镇" style="width: 100px;float: left;" />
            <a style="margin-left: 10px;" id="Btn" type="button" class="btn btn-primary">查询</a>
        </div>
        <div id="tab"></div>
    </div>
</body>
<script>
    function buildtab(quyu) {
        var htmlstr = "";
        htmlstr += `<table class="table table-hover" border="1px solid gray">
    <thead>
        <tr>
            <th style="text-align: center;">名称</th>
            <th style="text-align: center;">操作</th>
        </tr>
    </thead>
    <tbody>`;
        for (i = 0; i <= quyu.length - 1; i++) {
            htmlstr += `<tr>
        <td style="padding: 1.95%;vertical-align: middle;text-align:center;">${quyu[i]}</td>
        <td style="padding: 1.95%;text-align:center;"><div class="btn-group">
	<button type="button" class="btn btn-primary dropdown-toggle btn-sm" 
			data-toggle="dropdown">
		操作 <span class="caret"></span>
	</button>
	<ul class="dropdown-menu" role="menu" style="min-width:10%">
		<li><a onclick="DW(this)" href="javascript:void(0)">定位</a></li>
        <li class="divider"></li>
		<li><a onclick="CX(this)" href="javascript:void(0)">查询</a></li>
	</ul></div></td></tr>`;
        }
        htmlstr += `</tbody></table>`;
        document.getElementById("tab").innerHTML = htmlstr
    }
    DW = function (obj) {
        var x = $(obj).parent().parent().parent().parent().parent().find("td").eq(0).text();
        alert(x)
    }

</script>
<script type="text/javascript">
    require(["esri/map",
        "esri/layers/ArcGISDynamicMapServiceLayer",
        "dojo/on",
        "dojo/dom",
        "esri/layers/FeatureLayer",
        "esri/layers/GraphicsLayer",
        "esri/InfoTemplate",
        "esri/tasks/FindTask",
        "esri/tasks/FindParameters",
        "esri/symbols/SimpleLineSymbol",
        "esri/symbols/SimpleFillSymbol",
        "esri/graphic",
        "dojo/domReady!"], funFindTask);
    function funFindTask(Map, ArcGISDynamicMapServiceLayer, on, dom, FeatureLayer, GraphicsLayer, InfoTemplate, FindTask, FindParameters, SimpleLineSymbol, SimpleFillSymbol, Graphic) {
        //添加动态地图服务图层
        var map = new esri.Map("mapDiv", {
            center: [119.86842, 25.554367],
            zoom: 11,
            basemap: "topo",
            logo: false,
        });
        var layerUrl = "http://localhost:6080/arcgis/rest/services/my/PT/FeatureServer/0";
        var Flayer = new FeatureLayer(layerUrl, {
            infoTemplate: new InfoTemplate("${镇名}", "2017年脆弱度为:${F2017}"),
            mode: FeatureLayer.MODE_ONDEMAND,
            outFields: ["*"]
        });
        var MapServer = "http://localhost:6080/arcgis/rest/services/my/PT/MapServer";
        var layer = new ArcGISDynamicMapServiceLayer(MapServer);
        var glayer = new GraphicsLayer();
        map.addLayers([Flayer, layer, glayer])

        //显示所有要素图层
        layer.setVisibleLayers([0, 1, 2]);
        //显示所有要素图层
        var findTask = new FindTask(MapServer);
        //创建属性查询参数
        var findParams = new FindParameters();
        //给属性查询按钮添加click事件
        on(dom.byId("Btn"), "click", funFind);
        function funFind() {
            findParams.returnGeometry = true;
            //设置查询图层
            findParams.layerIds = [0];
            //设置查询的字段
            findParams.searchFields = ["镇名"];
            //设置查询条件
            findParams.searchText = txtSearchText.value;
            //执行查询对象
            findTask.execute(findParams, funShowFindResult);
        }
        function funShowFindResult(queryResult) {
            console.log(queryResult)
            glayer.clear()
            //创建线符号
            var lineSymbol = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new dojo.Color([0, 0, 255]), 3);
            //创建面符号
            var fill = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, lineSymbol, new dojo.Color([0, 255, 0, 0.6]));
            //未返回查询结果时不添加结果表格
            if (queryResult.length == 0) {
                return;
            }
            //返回查询结果时添加结果表格，并设置表格内容
            if (queryResult.length >= 1) {
                var quyu = [];
                for (var i = 0; i < queryResult.length; i++) {
                    //获得图形graphic
                    var graphic = queryResult[i].feature;
                    //赋予相应的符号
                    graphic.setSymbol(fill);
                    //将graphic添加到地图中，从而实现高亮效果
                    glayer.add(graphic);
                    //获得属性表中STATE_NAME的值
                    var ptName = graphic.attributes["镇名"];
                    quyu.push(ptName);
                }
                buildtab(quyu)
            }
        }
    }
</script>

</html>