<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>福州市古厝文化信息检索与展示系统</title>
    <link rel="icon" type="image/x-icon" href="/images/title.ico" />
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    <link href="/css/second.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="/css/sweetalert.css">
    <script type="text/javascript" src="/js/sweetalert-dev.js"></script>
    <script type="text/javascript"
        src="http://api.map.baidu.com/api?v=3.0&ak=2GVVoVth63ABPvY68rX4dek93chHmGjT"></script>
    <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript"
        src="//api.map.baidu.com/library/TextIconOverlay/1.2/src/TextIconOverlay_min.js"></script>
    <script type="text/javascript" src="/js/MarkerClusterer.js"></script>
    <script src="http://html2canvas.hertzen.com/dist/html2canvas.js"></script>
</head>

<body>
    <iframe src="navbar.html" style="display:block;" height="126px" width="100%" frameborder="0"></iframe>
    <iframe src="navbar2.html" style="display:block;float: left;margin-right: 0.15%;" width="11.5%" height="80%"
        frameborder="0"></iframe>
    <div class="container" id="allmap" style="width: 88.35%;">
        <!-- 第二页内容区 -->
    </div>
    <hr>
    <!-- 底部 -->
    <div id="foot">
        <span id="span2">2017级地理信息科学本科团支部</span>
    </div>
</body>
<script type="text/javascript" src="/js/custom_map_config.js"></script>
<script type="text/javascript" src="/js/mapdata.js"></script>
<script type="text/javascript" src="/js/tmap.js"></script>
<script type="text/javascript">
    // 比例尺控件
    map.addControl(
        new BMap.ScaleControl({
            anchor: BMAP_ANCHOR_BOTTOM_RIGHT,
            offset: new BMap.Size(260, 15)
        })
    );
    function label() {
        this.defaultAnchor = BMAP_ANCHOR_BOTTOM_RIGHT;
        this.defaultOffset = new BMap.Size(80, 230);
    }
    label.prototype = new BMap.Control();
    label.prototype.initialize = function (map) {
        var div = document.createElement("span");
        div.innerText = "古厝类型"
        div.style.color = "black"
        div.style.fontSize = "20px"
        map.getContainer().appendChild(div);
        return div;
    };
    var myZoomCtrl = new label();
    map.addControl(myZoomCtrl);

    var xhr = new XMLHttpRequest();
    xhr.open("GET", "/php/users.php", true);
    xhr.onload = function () {
        var users0 = JSON.parse(this.responseText); //拿数据
        var type_rs0 = []
        for (y = 0; y < type_rs.length; y++) {
            type_rs0[y] = type_rs[y].name
        }
        var markers = new Array();
        const users = users0.filter(item => type_rs0.indexOf(item.type) > -1)
        for (var i in users) {
            for (y = 0; y < type_rs.length; y++) {
                if (users[i].type == type_rs[y].name) {
                    var point = new BMap.Point(users[i].xposition, users[i].yposition);
                    var myIcon = new BMap.Icon("/images/" + type_rs[y].ename + ".png", new BMap.Size(15, 15));
                    myIcon.setImageSize(new BMap.Size(15, 15))
                    var marker = new BMap.Marker(point, { icon: myIcon });
                }
            }
            var content = '<div class="div2"><div id="' + users[i].name + '" class="carousel slide" style="width: 200px;height: 130px;">' +
                '<ol class="carousel-indicators" style="height: 0px">' +
                '<li data-target="#' + users[i].name + '" data-slide-to="0" class="active"></li>' +
                '<li data-target="#' + users[i].name + '" data-slide-to="1"></li>' +
                '<li data-target="#' + users[i].name + '" data-slide-to="2"></li></ol><div class="carousel-inner" id="pic"><div class="item active">' +
                '<img src=' + users[i].img1 + ' alt="First slide" style="width: 200px;height: 130px;"><div class="carousel-caption" style="width: 120px;height: 0px;">第一张</div></div><div class="item">' +
                '<img src=' + users[i].img2 + ' alt="Second slide" style="width: 200px;height: 130px;"><div class="carousel-caption" style="width: 120px;height: 0px;">第二张</div></div><div class="item">' +
                '<img src=' + users[i].img3 + ' alt="Third slide" style="width: 200px;height: 130px;"><div class="carousel-caption" style="width: 120px;height: 0px;">第三张</div></div></div>' +
                '<a class="left carousel-control" style="background:transparent;" href="#' + users[i].name + '" role="button" data-slide="prev">' +
                '<span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>' +
                '<span class="sr-only">Previous</span></a>' +
                '<a class="right carousel-control" style="background:transparent;" href="#' + users[i].name + '" role="button" data-slide="next">' +
                '<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>' +
                '<span class="sr-only">Next</span>' +
                '</a><div style="background-color: aliceblue;margin-top: 15px;border-radius: 10px;">' +
                '<div class="p1"><a >' + users[i].name + '</a></div><div class="p2">' +
                '<span class="p">地址：' + users[i].address + '</span><br>' +
                '<span class="p">类别：' + users[i].type + '</span><br>' +
                '<span class="p">保护等级：' + users[i].grade + '</span><br>' +
                '<span class="p">所在地：' + users[i].located + '</span><br>' +
                '<span class="p">建造年代：' + users[i].buildtime + '</span><br>' +
                '<a id="button2" type="button" class="btn btn-primary" onclick= swal("' + users[i].name + '","' + users[i].xiangxi + '")>详情</a>'
            '</div></div></div></div>'
            addClickHandler(content, marker);
            markers.push(marker);
            map.addOverlay(marker); // 将标注添加到地图中
            /* marker.setAnimation(BMAP_ANIMATION_BOUNCE); */
            marker.disableMassClear();
        }
        var markerClusterer = new BMapLib.MarkerClusterer(map, { markers: markers, minClusterSize: 10 });
        function addClickHandler(content, marker) {
            marker.addEventListener("click", function (e) {
                openInfo(content, e);
            });
        }
        var opts = {
            enableAutoPan: true, // 是否开启信息窗口打开时地图自动移动，本应开启，但API v3.0 此功能有问题,后面在打开信息窗口内重写这种效果
        };
        function openInfo(content, e) {
            var p = e.target;
            var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);
            var infoWindow = new BMap.InfoWindow(content, opts); // 创建信息窗口对象
            map.openInfoWindow(infoWindow, point); //开启信息窗口
            /* map.centerAndZoom(new BMap.Point(p.getPosition().lng, p.getPosition().lat), getZoom());// 重写 是否开启信息窗口打开时地图自动移动 */
        }


        sk = function (xposition, yposition, img1, name, address, type, grade, located, buildtime, xiangxi) {
            $("#x1").hide();
            var content = '<div class="div2"><div id="' + name + '" class="carousel slide" style="width: 200px;height: 130px;">' +
                '<ol class="carousel-indicators" style="height: 0px">' +
                '<li data-target="#' + name + '" data-slide-to="0" class="active"></li>' +
                '<li data-target="#' + name + '" data-slide-to="1"></li>' +
                '<li data-target="#' + name + '" data-slide-to="2"></li></ol><div class="carousel-inner" id="pic"><div class="item active">' +
                '<img src=' + img1 + ' alt="First slide" style="width: 200px;height: 130px;"><div class="carousel-caption" style="width: 120px;height: 0px;">第一张</div></div><div class="item">' +
                '<img src=' + img1 + ' alt="Second slide" style="width: 200px;height: 130px;"><div class="carousel-caption" style="width: 120px;height: 0px;">第二张</div></div><div class="item">' +
                '<img src=' + img1 + ' alt="Third slide" style="width: 200px;height: 130px;"><div class="carousel-caption" style="width: 120px;height: 0px;">第三张</div></div></div>' +
                '<a class="left carousel-control" style="background:transparent;" href="#' + name + '" role="button" data-slide="prev">' +
                '<span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>' +
                '<span class="sr-only">Previous</span></a>' +
                '<a class="right carousel-control" style="background:transparent;" href="#' + name + '" role="button" data-slide="next">' +
                '<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>' +
                '<span class="sr-only">Next</span>' +
                '</a><div style="background-color: aliceblue;margin-top: 15px;border-radius: 10px;">' +
                '<div class="p1"><a >' + name + '</a></div><div class="p2">' +
                '<span class="p">地址：' + address + '</span><br>' +
                '<span class="p">类别：' + type + '</span><br>' +
                '<span class="p">保护等级：' + grade + '</span><br>' +
                '<span class="p">所在地：' + located + '</span><br>' +
                '<span class="p">建造年代：' + buildtime + '</span><br>' +
                '<a id="button2" type="button" class="btn btn-primary" onclick= swal("' + name + '","' + xiangxi + '")>详情</a>'
            '</div></div></div></div>'

            var opts = {
                enableAutoPan: true, // 是否开启信息窗口打开时地图自动移动，本应开启，但API v3.0 此功能有问题,后面在打开信息窗口内重写这种效果
            };
            var point = new BMap.Point(xposition, yposition);
            var infoWindow = new BMap.InfoWindow(content, opts); // 创建信息窗口对象
            map.openInfoWindow(infoWindow, point); //开启信息窗口
        }

        function type(type) {
            $("#x1").show();
            document.getElementById("x1").style.height = "auto"
            document.getElementById("x1").style.overflow = "hidden"
            document.getElementById("x1").innerHTML = ""
            for (var y in users) {
                if (users[y].type == type) {
                    document.getElementById("x1").style.border = "1px solid gray"
                    document.getElementById("x1").innerHTML += `<div style="height: 77px;width: 220px;padding:2.5% 0 2.5% 0;background: white;white-space:normal;word-break:break-all;word-wrap:break-word;">
                               <img src="${users[y].img1}" style="height: 100%;width: 40%;float: left;margin-left: 5%;"></img>
                               <div style="padding-left:2px;padding-top:2px;height: 100%;width: 50%;background: aliceblue;float: left;line-height: 1.2;"><a style="display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size: 7px;" href="javascript:void(0)" onclick= sk(${users[y].xposition},${users[y].yposition},"${users[y].img1}","${users[y].name}","${users[y].address}","${users[y].type}","${users[y].grade}","${users[y].located}","${users[y].buildtime}","${users[y].xiangxi}") >${users[y].name}</a><span style="font-size: 7px;">所在地：${users[y].located}</span><br><span style="font-size: 7px;">保护等级：${users[y].grade}</span><br><span style="font-size: 7px;">建造年代：${users[y].buildtime}</span></div>
                               </div>`
                } else {
                    document.getElementById("x1").innerHTML += ""
                }
            }
            if ($("#x1").height() > 465) {
                document.getElementById("x1").style.height = "465px"
                document.getElementById("x1").style.overflow = "scroll"
            }
        }

        for (i = 0; i < type_rs.length; i++) {
            function type_rs0() {
                this.defaultAnchor = BMAP_ANCHOR_BOTTOM_RIGHT;
                this.defaultOffset = new BMap.Size(type_rs[i].size_x, type_rs[i].size_y);
            }
            type_rs0.prototype = new BMap.Control();
            type_rs0.prototype.initialize = function (map) {
                var div = document.createElement("a");
                div.href = "javascript:void(0)"
                div.id = type_rs[i].ename
                div.style.width = "20px";
                div.style.height = "20px";
                div.style.backgroundImage = "url(/images/" + type_rs[i].ename + ".png)"
                div.style.backgroundRepeat = "no-repeat"
                div.style.backgroundSize = "100% 100%"
                /* div.onclick = alert(type_rs[i].name) */
                map.getContainer().appendChild(div);
                return div;
            };
            var myZoomCtrl = new type_rs0();
            map.addControl(myZoomCtrl);
            //label
            function lale0() {
                this.defaultAnchor = BMAP_ANCHOR_BOTTOM_RIGHT;
                this.defaultOffset = new BMap.Size(type_rs[i].label_x, type_rs[i].label_y);
            }
            lale0.prototype = new BMap.Control();
            lale0.prototype.initialize = function (map) {
                var div = document.createElement("div");
                div.innerText = type_rs[i].name
                div.style.width = "60px";
                map.getContainer().appendChild(div);
                return div;
            };
            var myZoomCtrl = new lale0();
            map.addControl(myZoomCtrl);
        }
        for (i = 0; i < type_rs.length; i++) {
            document.getElementById(type_rs[i].ename).addEventListener("click", type_k(type_rs[i].name));
            function type_k(args) {
                return function (e) {
                    $("#x1").hide();
                    type(args)
                }
            }
        }
    }
    xhr.send();

</script>

</html>